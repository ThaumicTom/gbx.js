/* GBXjs 0.2.0 - (c) Petr Pivoňka & Tom - released under MIT */
!function(e){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e.apply(null,[].map(function(e){return require(e)}));else if("function"==typeof define&&define.amd)define([],e);else{var n;(n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).GBX=e.apply(null,[].map(function(e){return n[e]}))}}(function(){var e,n,t,r,o,u,l,s=[],d=[],m=[],h=null,c=0,p=new TextDecoder,b={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium®",10003:"Common"};function g(e){f=this.read,e.data.constructor!==Uint8Array?async function(){var n;e.data=new Uint8Array(await(n=e.data,new Promise((e,t)=>{let a=new FileReader;a.addEventListener("loadend",n=>e(n.target.result)),a.addEventListener("error",t),a.readAsArrayBuffer(n)}))),y(e,f)}():y(e,f)}function y(e,n){e.thumbnail&&(this.thumb=e.thumbnail),this.onParse=e.onParse,this.buffer=e.data,void 0!==this.buffer?n(this.buffer):l=0}function v(e){u=e,c=0}function w(){return r=u[c],c+=1,r}function k(e){for(o=new Uint8Array(e),i=0;i<e;i++)o[i]=w();return o}function T(){return(o=k(4))[0]|o[1]<<8|o[2]<<16|o[3]<<24}function x(){return(o=k(8))[0]|o[1]<<8|o[2]<<16|o[3]<<24|o[4]<<32|o[5]<<40|o[6]<<48|o[7]<<56}function C(e){return null==e&&(e=T()),p.decode(k(e))}function S(){return C(1)}function U(){null==h&&(h=T());var e=new Uint32Array([T()])[0];if(0==(16383&e)&&(e>>30==1||e>>30==-2)){var n=C();return d.push(n),n}if(16383!=(16383&e))return e>>30==0?null==b[e]?(l=4,e):b[e]:d.Count>(16383&e)-1?d[(16383&e)-1]:"";switch(e>>30){case 2:return"Unassigned";case 3:return"";default:l=10}}function z(){return{id:U(),collection:U(),author:U()}}function I(){return!!T()}function V(){return T().toFixed(2)}function $(){return{x:V(),y:V()}}function A(e){return btoa(new Uint8Array(e).reduce(function(e,n){return e+String.fromCharCode(n)},""))}return g.prototype.read=function(){var r=performance.now();if(u=this.buffer,"GBX"==C(3)){if((e=(o=k(2))[0]|o[1]<<8)>=3&&(S(),S(),S(),e>=4&&S(),n=T(),e>=6&&T()>0)){for(t=T(),a=0;a<t;a++){var i=4095&T(),f=T(),d=0!=(f&1<<31);s[i]={size:2147483647&f,isHeavy:d}}for(var h in s)s[h].data=k(s[h].size),delete s[h].size;if(50606080==n){v(s[2].data),(p=w())<3&&(m.mapInfo=z(),m.mapName=C()),T(),p>=1&&(m.bronzeTime=T(),m.silverTime=T(),m.goldTime=T(),m.authorTime=T(),2==p&&w(),p>=4&&(m.cost=T(),p>=5&&(m.isMultilap=I(),6==p&&I(),p>=7&&(m.trackType=T(),p>=9&&(T(),p>=10&&(m.authorScore=T(),p>=11&&(m.editorMode=T(),p>=12&&(I(),p>=13&&(m.nbCheckpoints=T(),m.nbLaps=T()))))))))),v(s[3].data);var c=w();if(m.mapInfo=z(),m.mapName=C(),m.mapNameD=m.mapName.replace(/\$\$/g,"$\\").replace(/\$([a-f0-9]){3}|\$([a-f0-9]){1,2}(?=[^a-f0-9])|\$([lh]\[.*?\]|[g-il-ostwz])/gi,"").replace(/\$\\/,"$"),6==w()&&(l=3),c>=1&&(m.locked=I(),m.password=C(),c>=2&&(m.decoration=z(),c>=3&&(m.mapOrigin=$(),c>=4&&(m.mapTarget=$(),c>=5&&(x(),x(),c>=6&&(m.mapType=C(),m.mapStyle=C(),c<=8&&I(),c>=8&&(m.lightmapCacheUID=A(k(8)),c>=9&&(m.lightmapVersion=w(),c>=11&&(m.titleUID=U()))))))))),v(s[5].data),m.xml=C(),this.thumb)v(s[7].data),0!=T()&&(m.thumbnailSize=T(),C("<Thumbnail.jpg>".length),0==m.thumbnailSize?m.thumbnail=null:m.thumbnail=k(m.thumbnailSize),C("</Thumbnail.jpg>".length),C("<Comments>".length),m.comments=C(),C("</Comments>".length)),"base64"==this.thumb&&(m.thumbnail=A(m.thumbnail));v(s[8].data),T(),m.authorVersion=T(),m.authorLogin=C(),m.authorNickname=C(),m.authorZone=C(),m.authorExtraInfo=C()}else if(50933760==n){v(s[0].data),chunk000Version=T(),chunk000Version>=2&&(m.mapInfo=z(),m.time=T(),m.driverNickname=C(),chunk000Version>=6&&(m.driverLogin=C(),chunk000Version>=8&&(w(),m.titleUID=U()))),v(s[1].data),m.xml=C(),v(s[2].data);var p=T();m.authorVersion=T(),m.authorLogin=C(),m.authorNickname=C(),m.authorZone=C(),m.authorExtraInfo=C()}else l=2}}else l=1;var b=performance.now();void 0!==this.onParse&&this.onParse.length>0&&this.onParse(m,l,b-r)},g});