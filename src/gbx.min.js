var gbx,version,format,refTableCompression,bodyCompression,unknown,classID,userDataSize,userData,numHeaderChunks,headerChunks=[],metadata=[],lookbackVersion=null,lookbackStrings=[],collectionIDs={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium\xAE",10003:"Common"};function readGbx(b){if(buffer=b,lookbackVersion=null,lookbackStrings=[],gbx=readString(3),"GBX"==gbx&&(version=readInt16(),3<=version&&(format=readChar(),refTableCompression=readChar(),bodyCompression=readChar(),4<=version&&(unknown=readChar()),classID=readInt32(),6<=version&&(userDataSize=readInt32(),0<userDataSize)))){for(numHeaderChunks=readInt32(),a=0;a<numHeaderChunks;a++){var c=4095&readInt32(),d=readInt32();headerChunks[c]={size:2147483647&d,isHeavy:0!=(-2147483648&d)}}for(var e in headerChunks)headerChunks[e].data=readBytes(headerChunks[e].size),delete headerChunks[e].size;if(50606080==classID){changeBuffer(headerChunks[2].data);var f=readByte();3>f&&(metadata.mapInfo=readMeta(),metadata.mapName=readString()),readInt32(),1<=f&&(metadata.bronzeTime=readInt32(),metadata.silverTime=readInt32(),metadata.goldTime=readInt32(),metadata.authorTime=readInt32(),2==f&&readByte(),4<=f&&(metadata.cost=readInt32(),5<=f&&(metadata.isMultilap=readBool(),6==f&&readBool(),7<=f&&(metadata.trackType=readInt32(),9<=f&&(readInt32(),10<=f&&(metadata.authorScore=readInt32(),11<=f&&(metadata.editorMode=readInt32(),12<=f&&(readBool(),13<=f&&(metadata.nbCheckpoints=readInt32(),metadata.nbLaps=readInt32()))))))))),changeBuffer(headerChunks[3].data);var g=readByte();metadata.mapInfo=readMeta(),metadata.mapName=readString();var h=readByte();6==h&&console.error("[gbx.js] Unvalidated map."),1<=g&&(metadata.locked=readBool(),metadata.password=readString(),2<=g&&(metadata.decoration=readMeta(),3<=g&&(metadata.mapOrigin=readVec2(),4<=g&&(metadata.mapTarget=readVec2(),5<=g&&(readInt64(),readInt64(),6<=g&&(metadata.mapType=readString(),metadata.mapStyle=readString(),8>=g&&readBool(),8<=g&&(metadata.lightmapCacheUID=toBase64(readBytes(8)),9<=g&&(metadata.lightmapVersion=readByte(),11<=g&&(metadata.titleUID=readLookbackString()))))))))),changeBuffer(headerChunks[5].data),metadata.xml=readString(),changeBuffer(headerChunks[7].data);var j=readInt32();0!=j&&(metadata.thumbnailSize=readInt32(),readString(15),0==metadata.thumbnailSize?(metadata.thumbnail=null,console.warn("[gbx.js] No thumbnail.")):metadata.thumbnail=readBytes(metadata.thumbnailSizethumbSize),readString(16),readString(10),metadata.comments=readString(),readString(11)),changeBuffer(headerChunks[8].data);readInt32();metadata.authorVersion=readInt32(),metadata.authorLogin=readString(),metadata.authorNickname=readString(),metadata.authorZone=readString(),metadata.authorExtraInfo=readString()}else if(50933760==classID){changeBuffer(headerChunks[0].data),chunk000Version=readInt32(),2<=chunk000Version&&(metadata.mapInfo=readMeta(),metadata.time=readInt32(),metadata.driverNickname=readString(),6<=chunk000Version&&(metadata.driverLogin=readString(),8<=chunk000Version&&(readByte(),metadata.titleUID=readLookbackString()))),changeBuffer(headerChunks[1].data),metadata.xml=readString(),changeBuffer(headerChunks[2].data);var f=readInt32();metadata.authorVersion=readInt32(),metadata.authorLogin=readString(),metadata.authorNickname=readString(),metadata.authorZone=readString(),metadata.authorExtraInfo=readString()}else console.error("[gbx.js] Error parsing: Not a map or replay file.")}}var buffer,pointer=0,previousPointerPos=0,utf8decoder=new TextDecoder;function changeBuffer(b){buffer=b,previousPointerPos=pointer,pointer=0}function peekByte(){return buffer[pointer]}function peekBytes(b){var c=new Uint8Array(b);for(i=0;i<b;i++)c[i]=buffer[pointer+i];return c}function readByte(){var b=peekByte();return pointer+=1,b}function readBytes(b){var c=new Uint8Array(b);for(i=0;i<b;i++)c[i]=readByte();return c}function readInt16(){var b=readBytes(2);return b[0]|b[1]<<8}function readInt32(){var b=readBytes(4);return b[0]|b[1]<<8|b[2]<<16|b[3]<<24}function readInt64(){var b=readBytes(8);return b[0]|b[1]<<8|b[2]<<16|b[3]<<24|b[4]<<32|b[5]<<40|b[6]<<48|b[7]<<56}function readString(b){return null==b&&(b=readInt32()),utf8decoder.decode(readBytes(b))}function readChar(){return readString(1)}function readLookbackString(){null==lookbackVersion&&(lookbackVersion=readInt32());var b=new Uint32Array([readInt32()])[0];if(0==(16383&b)&&(1==b>>30||-2==b>>30)){var c=readString();return lookbackStrings.push(c),c}if(16383==(16383&b))switch(b>>30){case 2:return"Unassigned";case 3:return"";default:console.error("[gbx.js] Error parsing: Unknown lookback error.");}else return 0==b>>30?null==collectionIDs[b]?(console.warn("[gbx.js] Unknown index: "+b),b):collectionIDs[b]:lookbackStrings.Count>(16383&b)-1?lookbackStrings[(16383&b)-1]:""}function readMeta(){return{id:readLookbackString(),collection:readLookbackString(),author:readLookbackString()}}function readBool(){return!!readInt32()}function readFloat(){return readInt32().toFixed(2)}function readVec2(){return{x:readFloat(),y:readFloat()}}function readVec3(){return{x:readFloat(),y:readFloat(),z:readFloat()}}function toHex(b){return b.toString(16)}function toBase64(b){return btoa([].reduce.call(new Uint8Array(b),function(b,d){return b+String.fromCharCode(d)},""))}