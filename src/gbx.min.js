/* GBXjs 0.3.0 - (c) Petr Pivoňka & Tom - released under MIT */
!function(e){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e.apply(null,[].map(function(e){return require(e)}));else if("function"==typeof define&&define.amd)define([],e);else{var n;(n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).GBX=e.apply(null,[].map(function(e){return n[e]}))}}(function(){var e,n,t,r,o,u,l,s,m,h,d=[],c=[],p=new TextDecoder,b={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium®",10003:"Common"};function g(e){f=this.read,e.data.constructor!==Uint8Array?async function(){var n;e.data=new Uint8Array(await(n=e.data,new Promise((e,t)=>{let a=new FileReader;a.addEventListener("loadend",n=>e(n.target.result)),a.addEventListener("error",t),a.readAsArrayBuffer(n)}))),y(e,f)}():y(e,f)}function y(e,n){e.thumbnail&&(this.thumb=e.thumbnail),this.onParse=e.onParse,this.onThumb=e.onThumb,this.buffer=e.data,void 0!==this.buffer?n(this.buffer):l=0}function T(e){u=e,s=0}function v(){return r=u[s],s+=1,r}function w(e){for(o=new Uint8Array(e),i=0;i<e;i++)o[i]=v();return o}function k(){return(o=w(4))[0]|o[1]<<8|o[2]<<16|o[3]<<24}function S(){return(o=w(8))[0]|o[1]<<8|o[2]<<16|o[3]<<24|o[4]<<32|o[5]<<40|o[6]<<48|o[7]<<56}function C(e){return null==e&&(e=k()),p.decode(w(e))}function U(){return C(1)}function x(){null==m&&(m=k());var e=new Uint32Array([k()])[0];if(0==(16383&e)&&(e>>30==1||e>>30==-2)){var n=C();return c.push(n),n}if(16383!=(16383&e))return e>>30==0?null==b[e]?(l=4,e):b[e]:c.Count>(16383&e)-1?c[(16383&e)-1]:"";switch(e>>30){case 2:return"Unassigned";case 3:return"";default:l=10}}function z(){return{id:x(),collection:x(),author:x()}}function I(){return!!k()}function V(){return k().toFixed(2)}function $(){return{x:V(),y:V()}}function A(e){return btoa(new Uint8Array(e).reduce(function(e,n){return e+String.fromCharCode(n)},""))}return g.prototype.read=function(){var i=performance.now();if(h=[],s=0,m=null,u=this.buffer,"GBX"==C(3)){if((e=(o=w(2))[0]|o[1]<<8)>=3&&(U(),U(),U(),e>=4&&U(),n=k(),e>=6&&k()>0)){for(t=k(),a=0;a<t;a++){var r=4095&k(),f=k(),c=0!=(f&1<<31);d[r]={size:2147483647&f,isHeavy:c}}for(var p in d)d[p].data=w(d[p].size),delete d[p].size;if(50606080==n){T(d[2].data),(y=v())<3&&(h.mapInfo=z(),h.mapName=C()),k(),y>=1&&(h.bronzeTime=k(),h.silverTime=k(),h.goldTime=k(),h.authorTime=k(),2==y&&v(),y>=4&&(h.cost=k(),y>=5&&(h.isMultilap=I(),6==y&&I(),y>=7&&(h.trackType=k(),y>=9&&(k(),y>=10&&(h.authorScore=k(),y>=11&&(h.editorMode=k(),h.isSimple=0!=(1&h.editorMode),h.hasGhostBlocks=0!=(2&h.editorMode),y>=12&&(I(),y>=13&&(h.nbCheckpoints=k(),h.nbLaps=k()))))))))),T(d[3].data);var b=v();h.mapInfo=z(),h.mapName=C(),h.mapNameD=h.mapName.replace(/\$\$/g,"$\\").replace(/\$([a-f0-9]){3}|\$([a-f0-9]){1,2}(?=[^a-f0-9])|\$([lh]\[.*?\]|[g-il-ostwz])/gi,"").replace(/\$\\/,"$"),6==v()&&(l=3),b>=1&&(h.locked=I(),h.password=C(),b>=2&&(h.decoration=z(),b>=3&&(h.mapOrigin=$(),b>=4&&(h.mapTarget=$(),b>=5&&(S(),S(),b>=6&&(h.mapType=C(),h.mapStyle=C(),b<=8&&I(),b>=8&&(h.lightmapCacheUID=A(w(8)),b>=9&&(h.lightmapVersion=v(),b>=11&&(h.titleUID=x())))))))));var g=h.titleUID;h.game="Trackmania"==g?"Trackmania®":"TMCE@nadeolabs"==g||"TMTurbo@nadeolabs"==g?"Trackmania Turbo":b<=5?"Trackmania 1":"ManiaPlanet",T(d[5].data),h.xml=C(),b>5&&(T(d[8].data),k(),h.authorVersion=k(),h.authorLogin=C(),h.authorNickname=C(),h.authorZone=C(),h.authorExtraInfo=C())}else if(50933760==n){T(d[0].data),chunk000Version=k(),chunk000Version>=2&&(h.mapInfo=z(),h.time=k(),h.driverNickname=C(),chunk000Version>=6&&(h.driverLogin=C(),chunk000Version>=8&&(v(),h.titleUID=x()))),T(d[1].data),h.xml=C(),T(d[2].data);var y=k();h.authorVersion=k(),h.authorLogin=C(),h.authorNickname=C(),h.authorZone=C(),h.authorExtraInfo=C()}else l=2}}else l=1;(void 0!==this.onParse&&this.onParse.length>0&&this.onParse(h,l,V-i),this.thumb)&&(T(d[7].data),0!=k()&&(h.thumbnailSize=k(),a,C("<Thumbnail.jpg>".length),0==h.thumbnailSize?h.thumbnail=null:h.thumbnail=w(h.thumbnailSize),C("</Thumbnail.jpg>".length),C("<Comments>".length),h.comments=C(),C("</Comments>".length)),"base64"==this.thumb&&(h.thumbnail=A(h.thumbnail)));void 0!==this.onThumb&&this.onThumb.length>0&&this.onThumb(h.thumbnail,h.thumbnailSize);var V=performance.now()},g});