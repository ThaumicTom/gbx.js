(function(b){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=b.apply(null,[].map(function(b){return require(b)}));else if("function"==typeof define&&define.amd)define([],b);else{var c;c="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,c.GBX=b.apply(null,[].map(function(b){return c[b]}))}})(function(){function b(b){this.buffer=b.data,b.thumbnail&&(this.thumb=b.thumbnail),this.onParse=b.onParse,void 0===this.buffer?F="[gbx.js] No data provided.":this.read(this.buffer)}function c(b){E=b,K=0}function d(){return E[K]}function e(){return C=d(),K+=1,C}function f(b){for(D=new Uint8Array(b),i=0;i<b;i++)D[i]=e();return D}function g(){return D=f(2),D[0]|D[1]<<8}function h(){return D=f(4),D[0]|D[1]<<8|D[2]<<16|D[3]<<24}function j(){return D=f(8),D[0]|D[1]<<8|D[2]<<16|D[3]<<24|D[4]<<32|D[5]<<40|D[6]<<48|D[7]<<56}function k(b){return null==b&&(b=h()),L.decode(f(b))}function l(){return k(1)}function m(){null==J&&(J=h());var b=new Uint32Array([h()])[0];if(0==(16383&b)&&(1==b>>30||-2==b>>30)){var c=k();return H.push(c),c}if(16383==(16383&b))switch(b>>30){case 2:return"Unassigned";case 3:return"";default:F="[gbx.js] Unknown lookback error.";}else return 0==b>>30?null==M[b]?(F="[gbx.js] Unknown index: "+b,b):M[b]:H.Count>(16383&b)-1?H[(16383&b)-1]:""}function n(){return{id:m(),collection:m(),author:m()}}function o(){return!!h()}function p(){return h().toFixed(2)}function q(){return{x:p(),y:p()}}function r(b){return btoa(new Uint8Array(b).reduce(function(b,c){var d=String.fromCharCode;return b+d(c)},""))}function s(b){return b.replace(/\$\$/g,"$\\").replace(/\$([a-f0-9]){3}|\$([a-f0-9]){1,2}(?=[^a-f0-9])|\$([lh]\[.*?\]|[g-il-ostwz])/gi,"").replace(/\$\\/,"$")}var t,u,v,w,x,y,z,A,B,C,D,E,F,G=[],H=[],I=[],J=null,K=0,L=new TextDecoder,M={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium\xAE",10003:"Common"},N="[gbx.js] ";return b.prototype.read=function(){var b=performance.now();if(E=this.buffer,t=k(3),"GBX"!=t)F=N+"Not a gbx file.";else if(u=g(),3<=u&&(v=l(),w=l(),x=l(),4<=u&&(y=l()),z=h(),6<=u&&(A=h(),0<A))){for(B=h(),a=0;a<B;a++){var d=4095&h(),p=h();G[d]={size:2147483647&p,isHeavy:0!=(-2147483648&p)}}for(var C in G)G[C].data=f(G[C].size),delete G[C].size;if(50606080==z){c(G[2].data);var D=e();3>D&&(I.mapInfo=n(),I.mapName=k()),h(),1<=D&&(I.bronzeTime=h(),I.silverTime=h(),I.goldTime=h(),I.authorTime=h(),2==D&&e(),4<=D&&(I.cost=h(),5<=D&&(I.isMultilap=o(),6==D&&o(),7<=D&&(I.trackType=h(),9<=D&&(h(),10<=D&&(I.authorScore=h(),11<=D&&(I.editorMode=h(),12<=D&&(o(),13<=D&&(I.nbCheckpoints=h(),I.nbLaps=h()))))))))),c(G[3].data);var H=e();I.mapInfo=n(),I.mapName=k(),I.mapNameD=s(I.mapName);var J=e();if(6==J&&(F=N+"Map unvalidated."),1<=H&&(I.locked=o(),I.password=k(),2<=H&&(I.decoration=n(),3<=H&&(I.mapOrigin=q(),4<=H&&(I.mapTarget=q(),5<=H&&(j(),j(),6<=H&&(I.mapType=k(),I.mapStyle=k(),8>=H&&o(),8<=H&&(I.lightmapCacheUID=r(f(8)),9<=H&&(I.lightmapVersion=e(),11<=H&&(I.titleUID=m()))))))))),c(G[5].data),I.xml=k(),this.thumb){c(G[7].data);var K=h();0!=K&&(I.thumbnailSize=h(),k(15),I.thumbnail=0==I.thumbnailSize?null:f(I.thumbnailSize),k(16),k(10),I.comments=k(),k(11)),"base64"==this.thumb&&(I.thumbnail=r(I.thumbnail))}c(G[8].data),h(),I.authorVersion=h(),I.authorLogin=k(),I.authorNickname=k(),I.authorZone=k(),I.authorExtraInfo=k()}else if(50933760==z){c(G[0].data),chunk000Version=h(),2<=chunk000Version&&(I.mapInfo=n(),I.time=h(),I.driverNickname=k(),6<=chunk000Version&&(I.driverLogin=k(),8<=chunk000Version&&(e(),I.titleUID=m()))),c(G[1].data),I.xml=k(),c(G[2].data);var D=h();I.authorVersion=h(),I.authorLogin=k(),I.authorNickname=k(),I.authorZone=k(),I.authorExtraInfo=k()}else F=N+"Not a map or replay file."}var L=performance.now();void 0!==this.onParse&&0<this.onParse.length&&this.onParse(I,F,L-b)},b});