/* GBXjs V1 */
!function(e){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e.apply(null,[].map(function(e){return require(e)}));else if("function"==typeof define&&define.amd)define([],e);else{var n;(n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).GBX=e.apply(null,[].map(function(e){return n[e]}))}}(function(){var e,n,t,r,o,u,l,f=[],m=[],s=[],d=null,h=0,c=new TextDecoder,p={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"StadiumÂ®",10003:"Common"},b="[gbx.js] ";function g(e){this.buffer=e.data,e.thumbnail&&(this.thumb=e.thumbnail),this.onParse=e.onParse,void 0!==this.buffer?this.read(this.buffer):l=b+"No data provided."}function y(e){u=e,h=0}function v(){return r=u[h],h+=1,r}function w(e){for(o=new Uint8Array(e),i=0;i<e;i++)o[i]=v();return o}function k(){return(o=w(4))[0]|o[1]<<8|o[2]<<16|o[3]<<24}function x(){return(o=w(8))[0]|o[1]<<8|o[2]<<16|o[3]<<24|o[4]<<32|o[5]<<40|o[6]<<48|o[7]<<56}function N(e){return null==e&&(e=k()),c.decode(w(e))}function T(){return N(1)}function C(){null==d&&(d=k());var e=new Uint32Array([k()])[0];if(0==(16383&e)&&(e>>30==1||e>>30==-2)){var n=N();return m.push(n),n}if(16383!=(16383&e))return e>>30==0?null==p[e]?(l=b+"Unknown index: "+e,e):p[e]:m.Count>(16383&e)-1?m[(16383&e)-1]:"";switch(e>>30){case 2:return"Unassigned";case 3:return"";default:l=b+"Unknown lookback error."}}function S(){return{id:C(),collection:C(),author:C()}}function U(){return!!k()}function z(){return k().toFixed(2)}function I(){return{x:z(),y:z()}}function V(e){return btoa(new Uint8Array(e).reduce(function(e,n){return e+String.fromCharCode(n)},""))}return g.prototype.read=function(){var i=performance.now();if(u=this.buffer,"GBX"==N(3)){if((e=(o=w(2))[0]|o[1]<<8)>=3&&(T(),T(),T(),e>=4&&T(),n=k(),e>=6&&k()>0)){for(t=k(),a=0;a<t;a++){var r=4095&k(),m=k(),d=0!=(m&1<<31);f[r]={size:2147483647&m,isHeavy:d}}for(var h in f)f[h].data=w(f[h].size),delete f[h].size;if(50606080==n){y(f[2].data),(p=v())<3&&(s.mapInfo=S(),s.mapName=N()),k(),p>=1&&(s.bronzeTime=k(),s.silverTime=k(),s.goldTime=k(),s.authorTime=k(),2==p&&v(),p>=4&&(s.cost=k(),p>=5&&(s.isMultilap=U(),6==p&&U(),p>=7&&(s.trackType=k(),p>=9&&(k(),p>=10&&(s.authorScore=k(),p>=11&&(s.editorMode=k(),p>=12&&(U(),p>=13&&(s.nbCheckpoints=k(),s.nbLaps=k()))))))))),y(f[3].data);var c=v();if(s.mapInfo=S(),s.mapName=N(),s.mapNameD=s.mapName.replace(/\$\$/g,"$\\").replace(/\$([a-f0-9]){3}|\$([a-f0-9]){1,2}(?=[^a-f0-9])|\$([lh]\[.*?\]|[g-il-ostwz])/gi,"").replace(/\$\\/,"$"),6==v()&&(l=b+"Map unvalidated."),c>=1&&(s.locked=U(),s.password=N(),c>=2&&(s.decoration=S(),c>=3&&(s.mapOrigin=I(),c>=4&&(s.mapTarget=I(),c>=5&&(x(),x(),c>=6&&(s.mapType=N(),s.mapStyle=N(),c<=8&&U(),c>=8&&(s.lightmapCacheUID=V(w(8)),c>=9&&(s.lightmapVersion=v(),c>=11&&(s.titleUID=C()))))))))),y(f[5].data),s.xml=N(),this.thumb)y(f[7].data),0!=k()&&(s.thumbnailSize=k(),N("<Thumbnail.jpg>".length),0==s.thumbnailSize?s.thumbnail=null:s.thumbnail=w(s.thumbnailSize),N("</Thumbnail.jpg>".length),N("<Comments>".length),s.comments=N(),N("</Comments>".length)),"base64"==this.thumb&&(s.thumbnail=V(s.thumbnail));y(f[8].data),k(),s.authorVersion=k(),s.authorLogin=N(),s.authorNickname=N(),s.authorZone=N(),s.authorExtraInfo=N()}else if(50933760==n){y(f[0].data),chunk000Version=k(),chunk000Version>=2&&(s.mapInfo=S(),s.time=k(),s.driverNickname=N(),chunk000Version>=6&&(s.driverLogin=N(),chunk000Version>=8&&(v(),s.titleUID=C()))),y(f[1].data),s.xml=N(),y(f[2].data);var p=k();s.authorVersion=k(),s.authorLogin=N(),s.authorNickname=N(),s.authorZone=N(),s.authorExtraInfo=N()}else l=b+"Not a map or replay file."}}else l=b+"Not a gbx file.";var g=performance.now();void 0!==this.onParse&&this.onParse.length>0&&this.onParse(s,l,g-i)},g});
